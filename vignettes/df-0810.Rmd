---
title: "easyclimate: Analysing the climate of a given period using data frames"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{easyclimate: Analysing the climate of a given period using data frames}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, collapse = TRUE, warning = FALSE, message = FALSE)
```

`easyclimate` aims to easily download daily climate data and calculate multiple climatic indices for a given set of points or polygons within Europe.

# Installation

You can download and install the latest version of `easyclimate` from github:

```{r, eval = FALSE}
remotes::install_github("VeruGHub/easyclimate")
```

# Example: introducing coordinates as a data frame

As the name suggests `easyclimate` is easy to use. To use it with an example we create a data frame containing two columns named `lon` and `lat` (longitude and latitude coordinates, respectively), and we download the daily climate data for our location for the specified period (e.g. 2008-2010).

```{r, results = "hide"}
library(easyclimate)
library(tidyverse)
library(viridis)
library(patchwork)
library(here)
```

First, we generate the coordinates to with the example.


```{r}
coords <- data.frame(
  lon = -2.41135, lat = 43.0329
  )

Sys.time()#Julen, diría por qué pones Sys.time
```

Second, we obtain the climatic data for our location. With the functions we download all data from 2008 to 2010, creating a data.frame for each climatic variable: precipitation (Prcp), minimum temperatures (Tmin) and maximum temperatures (Tmax).

```{r}
ex_prcp <- get_daily_climate(
  coords, 
  period = 2008 : 2010, 
  climatic_var = "Prcp",
  output = "df"
)

ex_tmin <- get_daily_climate(
  coords,
  period = 2008 : 2010,
  climatic_var = "Tmin",
  output = "df"
)

ex_tmax <- get_daily_climate(
  coords,
  period = 2008 : 2010,
  climatic_var = "Tmax",
  output = "df"
)

Sys.time()
```

Temperature and precipitation units are ºC\*100 and mm\*100  to avoid floating values. Now, we mutate each variable, include the date, month and year and we join all the data frames in the data frame "clim_join".

```{r}
glimpse(ex_prcp)
ex_prcp_date <- ex_prcp %>%
  mutate(
    prcp = Prcp / 100,
    date = as.Date(date),
    month = months(date),
    year = format(date, format = "%y")
         )

ex_min_date <- ex_tmin %>%
  mutate(
    tmin = Tmin / 100,
    date = as.Date(date)
  ) %>%
  select(
    tmin, date
  )

ex_max_date <- ex_tmax %>%
  mutate(
    tmax = Tmax / 100,
    date = as.Date(date)
  ) %>%
  select(
    tmax, date
  )

clim_join <- full_join(
  ex_prcp_date, ex_min_date, by = "date"
  ) %>%
  full_join(
    ex_max_date, by = "date"
    ) %>%
  select(
    !c(ID_coords, x, y, Prcp)
  ) %>%
  relocate(
    lon, lat, date, year, month, prcp, tmin, tmax
    )
```

Now, we calculate climate variables: mean annual precipitation and maximum temperature per month, and late-spring frost days. We visualise the results.

```{r, fig.width = 8, fig.height = 6}
gg_clim <- function(#Julen, creo que esto habría que comentarlo un poco.
  df,
  x,
  y,
  grouping,
  virop,
  title
  ){
  ggplot(df, aes(x = .data[[x]], y = .data[[y]], color = .data[[y]])) +
  geom_point() +
  facet_wrap(~year) +
  geom_line(aes(x = .data[[x]], y = .data[[y]], group = year)) +
  scale_colour_viridis(option = virop, direction = -1) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none",
    axis.title = element_blank(),
    panel.grid.major = element_line(colour = "grey90", size = 0.5),
    panel.background = element_blank(),
    plot.title = element_text(size = 10)
  )  +
  ggtitle(title)
}

months <- c(
  "February", "March", "April",
  "May", "June", "July", "August",
  "September", "October", "November", "December"
  )

# precipitation per month
gg_prcp <- clim_join %>%
  mutate(
    month = fct_relevel(month, months, after = 5)) %>%
  group_by(month, year) %>%
  mutate(prcp = sum(prcp)) %>% 
  gg_clim(
    x = "month",
    y = "prcp",
    virop = "mako",
    title = "Precipitation per month"
  )

# maximum temperature per month
gg_tmax <- clim_join %>%
  mutate(
    month = fct_relevel(month, months, after = 5)) %>%
  group_by(month, year) %>%
  filter(tmax == max(tmax)) %>%
  gg_clim(
    x = "month",
    y = "tmax",
    virop = "rocket",
    title = "Maximum temperature per month"
  )

months <- c( "March", "April",
             "May", "June")

# late-spring frost days
gg_tmin <- clim_join %>%
  filter(
    tmin < 0 & (
      month == "March" |
      month == "April" |
      month == "May" |
      month == "June")
  ) %>%
  mutate(n.days = sum(n())) %>%
  gg_clim(
    x = "month",
    y = "n.days",
    virop = "mako",
    #br = c(1, 5, 10),
    title = "Late-spring frost days"
  ) +
  scale_y_continuous(breaks = c(1, 5, 10))

# visualise and save all plots together
gg_prcp / gg_tmax / (plot_spacer() + plot_spacer() + gg_tmin) +
  plot_annotation(
  title = "Oñati (Gipuzkoa, Spain) climate 2008-2010",
)

ggsave(
  here("clim-08-10.png"), 
  width = 8, height = 6
)
```

# Learn more

`easyclimate` can handle different types of input and output objects or download data from multiple locations and periods. Check out the vignettes with more information on the other options in this package here:
