---
title: "easyclimate: Analysing the climate of spatial points for a given period"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{easyclimate: Analysing the climate of spatial points for a given period}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, collapse = TRUE, warning = FALSE, message = FALSE, fig.width = 6, fig.height = 4)
```

`easyclimate` aims to easily download daily climate data for a given set of points or polygons within Europe. You can download and install the latest version of `easyclimate` from github: https://github.com/VeruGHub/easyclimate

In this tutorial we will work through the basics of using easyclimate with coordinate points. At the end we will get a data.frame with climatic variables for our points.

# Example 1: Introducing coordinates as a data frame

First, specify longitude and latitude coordinates in a data frame with the column names `lon` and `lat`.

```{r}
library(easyclimate)
library(ggplot2)
library(dplyr)

coords <- data.frame(
  lon = rnorm(10, mean = -5.36, sd = 0.3), 
  lat = rnorm(10, mean = 37.40, sd = 0.4)
  )

countries <- map_data("world", region = c("Spain", "Portugal", "France"))

ggplot() +
	geom_polygon(data = countries, 
		aes(x = long, y = lat, group = group),
		fill = NA, colour = "black") + 
	geom_point(data = coords, aes(x = lon, y = lat)) +
  coord_fixed(xlim = c(-10, 2), ylim = c(36, 44), ratio = 1.3) + 
	xlab("Longitude") +
	ylab("Latitude") +
  theme_bw()

```

Now, download the climatic data for the selected locations. It is very simple, all you have to do is use the function `get_daily_climate`, specify the period (e.g. `2008 : 2010`), and the variables to be downloaded (precipitation `Prcp`, minimum temperatures `Tmin` and maximum temperatures `Tmax`).

```{r}

Sys.time() # to know how much it takes to download

ex_df_prcp <- get_daily_climate(
  coords = coords, 
  period = 2008 : 2010, 
  climatic_var = "Prcp"
)

ex_df_tmin <- get_daily_climate(
  coords = coords,
  period = 2008 : 2010,
  climatic_var = "Tmin"
)

ex_df_tmax <- get_daily_climate(
  coords = coords,
  period = 2008 : 2010,
  climatic_var = "Tmax"
)

Sys.time()

```

Temperature and precipitation units are ºC\*100 and mm\*100 to avoid floating values. You can mutate them and join all the variables in a data frame.

```{r}

ex_prcp_date <- ex_df_prcp %>%
  mutate(
    prcp = Prcp / 100,
    date = as.Date(date),
    month = months(date),
    year = format(date, format = "%y")
         )

ex_min_date <- ex_df_tmin %>%
  mutate(
    tmin = Tmin / 100,
    date = as.Date(date)
  ) %>%
  select(tmin, date)

ex_max_date <- ex_df_tmax %>%
  mutate(
    tmax = Tmax / 100,
    date = as.Date(date)
  ) %>%
  select(tmax, date)

clim_join <- full_join(ex_prcp_date, ex_min_date, by = "date") %>%
  full_join(ex_max_date, by = "date") %>%
  select(!c(ID_coords, x, y, Prcp)) %>%
  relocate(lon, lat, date, year, month, prcp, tmin, tmax)

head(clim_join)

```

Finally, you can visualize the daily climate results
 
```{r}

library(tidyr)

clim_df <- clim_join %>%
  mutate(tmean = (tmin + tmax) / 2) %>%
  pivot_longer(
    cols = c("tmin", "tmax", "tmean"),
    names_to = "temp_vars",
    values_to = "temp_values")

ggplot(clim_df, aes(x = temp_vars, y = temp_values, color = temp_vars)) +
  geom_violin(fill = "gray80", size = 1, alpha = .5) +
  coord_flip() +
  ylab("Temperature (ºC)") + xlab("Variables") +
  theme_bw()

ggplot(clim_df, aes(x = date, y = temp_values, color = temp_vars)) + 
  geom_point(alpha = .1) +
  scale_color_discrete(name = "Variables") +
  ylab("Temperature (ºC)") + xlab("Date") +
  theme_bw()

```

# Example 2: Introducing coordinates as a matrix

`easyclimate` handles different input data, try now with matrices!

```{r}

coords_m <- as.matrix(coords)

Sys.time()

ex_m_prcp <- get_daily_climate( 
  coords = coords_m, 
  period = 2008, # single year
  climatic_var = "Prcp"
)

Sys.time()

head(ex_m_prcp)

clim_m <- ex_m_prcp %>%
  mutate(
    prcp = Prcp / 100,
    date = as.Date(date),
    month = months(date),
    year = format(date, format = "%y")
    ) %>%
  relocate(x, y, date, year, month, prcp)

ggplot(clim_m, aes(x = date, y = prcp, color = prcp)) +
  geom_point() +
  scale_color_continuous(name = "Precipitation (mm)") +
  scale_y_continuous(expand = c(0, 0)) +
  coord_cartesian(ylim = c(0, 60)) +
  ylab("Daily precipitation (mm)") + xlab("Date") +
  theme_bw()

month_name <- format(ISOdate(2021, 1:12, 1), "%B")

clim_m %>%
  mutate(month = factor(month, month_name)) %>%
  ggplot(aes(x = month, y = prcp, color = month)) +
  geom_jitter(size = 2, alpha = .3, width = .3) +
  scale_y_continuous(expand = c(0,0), name = "Precipitation\n(mm)") +
  coord_flip(ylim = c(0, 60)) +
  ylab("Precipitation (mm)") + xlab("Month") +
  theme_bw()

```

# Example 3: Introducing coordinates as simple feature objects

```{r}

library(sf)

coords_sf <- st_as_sf(
  coords, 
  coords = c("lon", "lat")
  )

ex_sf_tmin <- get_daily_climate(
  coords = coords_sf, 
  period = "2001-01-01", # single day
  climatic_var = "Tmin"
  ) 

clim_sf <- ex_sf_tmin %>%
  mutate(tmin = Tmin / 100)

ggplot() +
	geom_polygon(data = countries, 
		aes(x = long, y = lat, group = group),
		fill = NA, colour = "black") + 
	geom_point(data = clim_sf, aes(x = x, y = y, color = tmin)) +
  coord_fixed(xlim = c(-10, 0), ylim = c(36, 40), ratio = 1.3) + 
  scale_color_continuous(type = "viridis", name = "Minimum\ntemperature (ºC)") +
	ylab("Latitude") + xlab("Longitude") +
  theme_bw()

```

# Learn more

Now you know how to extract a dataframe with different climatic variables with `easyclimate`, using point coordinates in different formats and downloading data from multiple locations and periods. Check out this [other vignette](/vignettes/ex2-vignette-terra.Rmd) if you need to extract the data of a complete area.
