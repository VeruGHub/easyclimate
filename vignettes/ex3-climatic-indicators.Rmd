---
title: "How to calculate basic climatic indicators with data downloaded using easyclimate"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to calculate basic climatic indicators with data downloaded using easyclimate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

First, let's download daily climatic data for a specific location and store it in a dataframe.

```{r}

library(easyclimate)
library(dplyr)

coords <- matrix(c(-5.36, 37.40), ncol = 2)

ex_prec <- get_daily_climate(coords, period = 2001:2005,
                             climatic_var = "Prcp")  

ex_tmin <- get_daily_climate(coords, period = 2001:2005,
                             climatic_var = "Tmin")

ex_tmax <- get_daily_climate(coords, period = 2001:2005,
                             climatic_var = "Tmax")

daily <- ex_prec %>% 
  full_join(ex_tmin) %>% 
  full_join(ex_tmax) 

```
Temperature and precipitation units are ÂºC\*100 and mm\*100 to avoid floating values.

```{r}
realvalue <- function(x) {x/100}

daily <- daily %>% 
  mutate_at(c("Prcp", "Tmin", "Tmax"), realvalue) %>%
  mutate(Tm = (Tmin + Tmax) / 2, #Daily mean temperature
         date = as.Date(date),
         month = format(date, format = "%m"),
         year = format(date, format = "%y"))
```

Average temperatures can be calculated by simply grouping the temperature by site or by the period of time we want to have the averages. 

```{r}

daily %>% 
  group_by(ID_coords) %>% 
  summarise(avgTmin = mean(Tmin),
            avgTm = mean(Tm),
            avgTmax = mean(Tmax))

daily %>% 
  group_by(year) %>% 
  summarise(avgTmin = mean(Tmin),
            avgTm = mean(Tm),
            avgTmax = mean(Tmax))

daily %>% 
  group_by(month) %>% 
  summarise(avgTmin = mean(Tmin),
            avgTm = mean(Tm),
            avgTmax = mean(Tmax))


```
Simmilarly, you can calculate accumulated precipitations: 

```{r}
daily %>% 
  group_by(year) %>% 
  summarise(sumPrec = sum(Prcp))

daily %>% 
  group_by(month) %>% 
  summarise(sumPrec = sum(Prcp))
```

Sometimes it can be useful to calculate the deviation of averaged values from a reference period. For example, considering the reference period as all the temporal range downloaded, you could calculate the deviations as follows:

```{r}

daily %>%   
  group_by(ID_coords, year) %>% 
  summarise(avgTm = mean(Tm)) %>% 
  group_by(ID_coords) %>% 
  mutate(refTm = mean(avgTm)) %>% #Reference mean temperature
  mutate(devTm = avgTm - refTm)

daily %>%   
  group_by(ID_coords, year) %>% 
  summarise(sumPrec = sum(Prcp)) %>% 
  group_by(ID_coords) %>% 
  mutate(refPrec = mean(sumPrec)) %>% #Reference precipitation
  mutate(devPrec =sumPrec - refPrec)


```
Having daily values allows to calculate variables on a daily base, such as the number of consecutive days above a high temperature threshold (i.e. heat waves), the number of spring frosts or the number of consecutive days without rain.

```{r}

library(tidyr)

##Heat waves

threshold <- 32

daily %>% 
   mutate(ID_coords = as.factor(ID_coords),
         year = as.factor(year)) %>% 
  group_by(ID_coords, year) %>% 
  mutate(event = ifelse(Tmax>=threshold, 1, 0), #NAs will be 0 
         start = c(1, diff(event) != 0),
         run = cumsum(start)) %>% 
    filter(event == 1) %>% 
    group_by(run, .add = TRUE) %>% 
    summarise(length=n()) %>% 
    ungroup(run) %>% 
    summarise(max_heatwave=max(length), #Maximum length of periods with consecutive days with temperature > threshold per year
              mean_heatwave=mean(length), #Mean length
              n_heatwave=n()) %>% #No. of events per year
    complete(ID_coords, year, fill=list(max_heatwave=NA, mean_heatwave=NA, nevents=0)) 

##Spring frosts

spring <- c("03","04","05") #March to May

daily %>% 
  mutate(ID_coords = as.factor(ID_coords),
         year = as.factor(year)) %>% 
  filter(month %in% spring) %>% 
  mutate(event = ifelse(Tmin < 0, 1, 0)) %>% #NAs will be 0 
  group_by(ID_coords, year) %>% 
  mutate(n_frost = sum(event)) %>% #No. of days with minimum temperature < 0 per year
  filter(event == 1) %>% 
  group_by(ID_coords, year, n_frost) %>% 
  summarise(mean_frost = mean(Tmin)/100) %>% #Mean minimum temperature of frost days
  complete(ID_coords, year, fill=list(n_frost = 0, mean_frost=NA)) 

#No-rain periods

threshold <- 30 #threshold in days to count extreme long events of no-rain

daily %>%  
  mutate(event = ifelse(Prcp==0, 1, 0), #NAs will be 0 
         start = c(1, diff(event) != 0)) %>% 
    group_by(ID_coords, year) %>% 
    mutate(run = cumsum(start)) %>% 
    filter(event == 1) %>% 
    group_by(ID_coords, year, run) %>% 
    summarise(length = n()) %>% 
    ungroup(run) %>% 
    summarise(max_norain = max(length), #Maximum length of periods of consecutive days without rain per year
              mean_norain = mean(length), #Mean length
              nevents = sum(length>threshold)) %>% #No. of events per year
  complete(ID_coords, year, fill = list(max_norain=NA, mean_norain=NA, nevents = 0))

```

Aditionally to these examples, the package *climInd* allows to calculate multiple climatic indicators based on daily climatic data. 

```{r}

library(ClimInd)

##No. of days with temperature > 32 on June-August

Tmax <- as.vector(daily$Tmax)
names(Tmax) <- as.character(format(daily$date, format = "%m/%d/%Y"))

d32(Tmax)

##Growing degree days and growing season length

Tm <- as.vector(daily$Tm)
names(Tm) <- as.character(format(daily$date, format = "%m/%d/%Y"))

gd4(data = Tm, time.scale = "year") #Growing degree days

gsl(data = Tm, time.scale = "year") #Growing season length

##Heavy precipitation days

Prec <- as.vector(daily$Prcp)
names(Prec) <- as.character(format(daily$date, format = "%m/%d/%Y"))

d50mm(data = Prec, time.scale = "month")

```

# Learn more

For learning all the details about downloading daily climatic data, please go to [this vignette](/vignettes/ex1-vignette-df-m-sf.Rmd) if you are interested in the climate of specific coordinates, or go to [this other](/vignettes/ex2-vignette-terra.Rmd) if you need to extract data for a region.




